# HTTPS代理性能优化指南

本文档提供了优化HTTPS代理服务器性能的详细指南，包括代码优化和系统配置调整。

## 代码优化

以下代码优化已实施：

1. **增加缓冲区大小**：
   - 将默认的32KB缓冲区增加到1MB，显著提高大文件传输速度
   - 通过配置文件可自定义缓冲区大小

2. **TCP连接优化**：
   - 禁用Nagle算法，减少小数据包传输延迟
   - 启用TCP保活机制，维持长连接稳定性
   - 增加读写缓冲区大小，提高数据吞吐量

3. **HTTP服务器配置**：
   - 优化读写超时时间，避免连接过早中断
   - 增加空闲连接超时，减少连接建立开销
   - 优化头部处理，提高请求解析效率

4. **数据压缩**：
   - 启用gzip压缩，减少网络传输数据量
   - 通过配置可开关压缩功能

5. **连接复用**：
   - 优化TCP连接参数，提高连接复用效率

## 系统优化

### Linux内核参数优化

使用提供的`scripts/optimize_system.sh`脚本可以自动调整以下系统参数：

1. **TCP网络栈优化**：
   - 增加最大并发连接数(`net.core.somaxconn`和`net.ipv4.tcp_max_syn_backlog`)
   - 优化TCP缓冲区大小(`net.ipv4.tcp_rmem`和`net.ipv4.tcp_wmem`)
   - 启用TCP窗口缩放(`net.ipv4.tcp_window_scaling`)
   - 启用TIME-WAIT复用(`net.ipv4.tcp_tw_reuse`)
   - 禁用TCP慢启动(`net.ipv4.tcp_slow_start_after_idle`)
   - 启用BBR拥塞控制算法，提高吞吐量和减少延迟

2. **文件描述符优化**：
   - 增加系统最大文件描述符数量(`fs.file-max`)
   - 设置进程文件描述符限制

3. **进程限制**：
   - 增加用户可创建的最大进程数

### systemd服务优化

对于使用systemd管理的服务，可以通过`deploy/systemd/https-proxy.service`配置：

1. **资源限制**：
   - 增加文件描述符限制(`LimitNOFILE`)
   - 增加进程数量限制(`LimitNPROC`)

2. **CPU和IO优化**：
   - 设置高优先级CPU调度策略
   - 设置实时IO调度

3. **内存管理**：
   - 分配足够的内存资源，避免交换

## 配置文件优化参数

在`config.json`中添加了性能相关配置参数：

```json
{
  "server": {
    "performance": {
      "buffer_size": 1048576,          // 缓冲区大小 (字节)
      "tcp_keep_alive": 30,            // TCP保活时间 (秒)
      "read_buffer_size": 2097152,     // TCP读缓冲区大小 (字节)
      "write_buffer_size": 2097152,    // TCP写缓冲区大小 (字节)
      "max_concurrent_conns": 1000,    // 最大并发连接数
      "enable_compression": true,      // 是否启用压缩
      "no_delay": true                 // 是否禁用Nagle算法
    }
  }
}
```

## 硬件建议

为获得最佳性能，推荐以下硬件配置：

1. **CPU**：多核处理器，至少4核
2. **内存**：至少8GB RAM，建议16GB或更多
3. **网络**：千兆或更高速度网卡
4. **存储**：SSD存储以提高IO性能

## 监控与调优

为持续优化性能，建议：

1. 监控系统资源使用情况
2. 分析网络流量模式
3. 根据实际使用情况调整配置参数
4. 定期更新系统内核与依赖库

## 限制与陷阱

在优化过程中需注意：

1. 过大的缓冲区可能导致内存使用过高
2. 某些TCP优化可能在特定网络环境下造成问题
3. 对于非常大量的并发连接，需要更多的系统资源
4. 启用压缩会增加CPU使用率，但减少网络带宽使用 